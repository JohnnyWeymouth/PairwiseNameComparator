name: Build and Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  build-go-binaries:
    name: Build Go Binary for ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            binary: PairwiseNameComparator
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            binary: PairwiseNameComparator
          - os: darwin
            arch: amd64
            runner: macos-latest
            binary: PairwiseNameComparator
          - os: darwin
            arch: arm64
            runner: macos-latest
            binary: PairwiseNameComparator
          - os: windows
            arch: amd64
            runner: windows-latest
            binary: PairwiseNameComparator.exe
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
    
    - name: Build Go Binary
      env:
        GOOS: ${{ matrix.os }}
        GOARCH: ${{ matrix.arch }}
        CGO_ENABLED: 0
      run: |
        go build -o ${{ matrix.binary }} -ldflags="-s -w" main.go
    
    - name: Upload Binary Artifact
      uses: actions/upload-artifact@v4
      with:
        name: binary-${{ matrix.os }}-${{ matrix.arch }}
        path: ${{ matrix.binary }}
        retention-days: 7

  build-wheels:
    name: Build Wheel for ${{ matrix.os }}
    needs: build-go-binaries
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
            artifact-pattern: binary-linux-*
          - os: macos
            runner: macos-latest
            artifact-pattern: binary-darwin-*
          - os: windows
            runner: windows-latest
            artifact-pattern: binary-windows-*
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Download Go Binaries
      uses: actions/download-artifact@v4
      with:
        pattern: ${{ matrix.artifact-pattern }}
        path: binaries/
        merge-multiple: true
    
    - name: List downloaded binaries (Debug)
      run: |
        ls -R binaries/
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools
    
    - name: Build wheel
      run: python -m build --wheel
    
    - name: Upload Wheel
      uses: actions/upload-artifact@v4
      with:
        name: wheel-${{ matrix.os }}
        path: dist/*.whl
        retention-days: 7

  publish:
    name: Publish to PyPI
    needs: build-wheels
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    environment:
      name: pypi
      url: https://pypi.org/p/PairwiseNameComparator
    permissions:
      id-token: write
    
    steps:
    - name: Download all wheels
      uses: actions/download-artifact@v4
      with:
        pattern: wheel-*
        path: dist/
        merge-multiple: true
    - name: Publish distribution ðŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        username: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}